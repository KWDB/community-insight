# KWDB Community Insight

KWDB Community Insight æ˜¯ä¸€ä¸ªç”¨äºå±•ç¤º KWDB ç¤¾åŒºå„é¡¹æŒ‡æ ‡å’Œå‘å±•è¶‹åŠ¿çš„å¯è§†åŒ–ä»ªè¡¨ç›˜ã€‚

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®çš„ä¸»è¦ç›®æ ‡æ˜¯èšåˆå’Œå±•ç¤ºå¼€æºç¤¾åŒºçš„å…³é”®æŒ‡æ ‡ã€‚

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- **ç°ä»£æŠ€æœ¯æ ˆ**ï¼šåŸºäº Next.js 14 (App Router) å’Œ React 18 å¼€å‘ã€‚
- **é™æ€å¯¼å‡º (SSG)**ï¼šæ”¯æŒå®Œå…¨é™æ€åŒ–è¾“å‡ºï¼Œé€‚é… GitHub Pages ç­‰é™æ€æ‰˜ç®¡ç¯å¢ƒã€‚
- **é…ç½®é©±åŠ¨**ï¼šé€šè¿‡ YAML æ–‡ä»¶å®šä¹‰å›¾è¡¨å…ƒæ•°æ®ï¼Œé€šè¿‡ TypeScript æ¨¡å—å®šä¹‰æ•°æ®æŸ¥è¯¢é€»è¾‘ï¼Œæ˜“äºæ‰©å±•ã€‚
- **PWA æ”¯æŒ**ï¼šå†…ç½® Manifest é…ç½®ï¼Œæ”¯æŒç§»åŠ¨ç«¯å®‰è£…å’Œç¦»çº¿è®¿é—®ä½“éªŒã€‚
- **è‡ªåŠ¨åŒ–è¿ç»´**ï¼šé›†æˆ GitHub Actionsï¼Œå®ç°è‡ªåŠ¨åŒ–æµ‹è¯•å’Œéƒ¨ç½²ã€‚

## ğŸ“– ä½¿ç”¨è¯´æ˜

### æ„å»ºä¸éƒ¨ç½²
æœ¬é¡¹ç›®é…ç½®ä¸ºé™æ€å¯¼å‡ºæ¨¡å¼ (`output: 'export'`)ã€‚

**æ„å»ºé™æ€æ–‡ä»¶ï¼š**
```bash
pnpm build
```
æ„å»ºäº§ç‰©å°†è¾“å‡ºåˆ° `out/` ç›®å½•ï¼Œå¯ç›´æ¥éƒ¨ç½²åˆ°ä»»ä½•é™æ€æ–‡ä»¶æœåŠ¡å™¨ã€‚

### å›¾è¡¨é…ç½® (YAML)
æ‰€æœ‰çš„å›¾è¡¨å®šä¹‰ä½äº `charts/` ç›®å½•ï¼Œæ¯ä¸€ä¸ª YAML æ–‡ä»¶ä»£è¡¨ä¸€ä¸ªå›¾è¡¨é…ç½®ã€‚

**é…ç½®ç¤ºä¾‹ï¼š**
```yaml
id: downloads_trend            # å”¯ä¸€æ ‡è¯†ç¬¦
title: Downloads Over Time     # å›¾è¡¨æ ‡é¢˜
description: è¶‹åŠ¿è¯´æ˜          # å›¾è¡¨æè¿°
queryModule: queries/downloadsTrend.ts   # å¯¹åº”çš„æ•°æ®æŸ¥è¯¢æ¨¡å—è·¯å¾„
viz: line                      # å¯è§†åŒ–ç±»å‹ï¼šline(æŠ˜çº¿), bar(æŸ±çŠ¶), area(é¢ç§¯), table(è¡¨æ ¼), stat(ç»Ÿè®¡å¡ç‰‡)
options:                       # å›¾è¡¨ç‰¹å®šé€‰é¡¹
  xKey: date                   # Xè½´å­—æ®µå
  yKey: count                  # Yè½´å­—æ®µå
section: trends                # å¸ƒå±€åˆ†åŒºæ ‡è¯†
order: 1                       # åˆ†åŒºå†…æ’åºæƒé‡
colSpan: 2                     # æ …æ ¼å ä½åˆ—æ•°
defaultTimeRange:              # é»˜è®¤æ—¶é—´èŒƒå›´
  from: now-7d
  to: now
refreshSec: 60                 # è‡ªåŠ¨åˆ·æ–°é—´éš”ï¼ˆç§’ï¼‰
```

### æ•°æ®æŸ¥è¯¢å¼€å‘
æŸ¥è¯¢é€»è¾‘ä½äº `queries/` ç›®å½•ã€‚æ¯ä¸ªæ¨¡å—éœ€è¦å¯¼å‡ºä¸€ä¸ªé»˜è®¤å‡½æ•°ï¼Œå¤„ç†ä¸ Supabase çš„äº¤äº’ã€‚

**æ—¶é—´è¿‡æ»¤ç¤ºä¾‹ï¼š**
```typescript
// åœ¨æŸ¥è¯¢æ¨¡å—ä¸­åº”ç”¨æ—¶é—´è¿‡æ»¤
import { timeFilter } from '@/lib/time';

export default async function query(supabase, params) {
  // ç”Ÿæˆ gte (å¤§äºç­‰äº) å’Œ lte (å°äºç­‰äº) æ—¶é—´è¾¹ç•Œ
  const { gte, lte } = timeFilter('date', params.range);
  
  const { data } = await supabase
    .from('downloads_view')
    .select('date, count')
    .gte('date', gte)
    .lte('date', lte);
    
  return { data };
}
```

### å·¥å…·å‡½æ•°è¯´æ˜ (`lib/queryUtils.ts`)
ä¸ºäº†ç®€åŒ–æ•°æ®å¤„ç†ï¼Œé¡¹ç›®æä¾›äº†ä¸€ç³»åˆ—å®ç”¨å·¥å…·å‡½æ•°ï¼š

- **`normalizeSeries(rows, opts)`**: å°†ä»»æ„è¡Œæ•°æ®è§„èŒƒåŒ–ä¸ºæ ‡å‡†çš„æ—¶é—´åºåˆ—æ•°æ®ï¼Œæ”¯æŒè‡ªåŠ¨æ’åºã€‚
- **`extractFromRpc(data, key)`**: ä» RPC è°ƒç”¨è¿”å›çš„ç»“æœä¸­æå–ç‰¹å®šæ•°å€¼ã€‚
- **`sumByKeys(rows, keys)`**: æ ¹æ®ä¼˜å…ˆçº§é”®åå¯¹è¡Œæ•°æ®è¿›è¡Œæ±‚å’Œèšåˆã€‚

## ğŸ“‚ é¡¹ç›®ç»“æ„

```text
kwdb-insight/
â”œâ”€â”€ app/                  # Next.js App Router é¡µé¢ä¸å¸ƒå±€
â”œâ”€â”€ components/           # React UI ç»„ä»¶ (å›¾è¡¨æ¸²æŸ“å™¨ã€æ§ä»¶ç­‰)
â”œâ”€â”€ charts/               # YAML å›¾è¡¨é…ç½®æ–‡ä»¶
â”œâ”€â”€ queries/              # TypeScript æ•°æ®æŸ¥è¯¢é€»è¾‘
â”œâ”€â”€ lib/                  # æ ¸å¿ƒå·¥å…·åº“ (Supabase å®¢æˆ·ç«¯ã€æ•°æ®å¤„ç†)
â”œâ”€â”€ public/               # é™æ€èµ„æº (Favicon, Manifest, Sitemap)
â”œâ”€â”€ .github/workflows/    # CI/CD è‡ªåŠ¨åŒ–å·¥ä½œæµé…ç½®
â””â”€â”€ tests/                # Playwright E2E æµ‹è¯•ç”¨ä¾‹
```

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ [Apache License 2.0](LICENSE) è®¸å¯è¯ã€‚
